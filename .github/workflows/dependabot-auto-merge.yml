name: Dependabot Auto-merge

on:
  pull_request:
    types: [opened, synchronize, reopened]

permissions:
  pull-requests: write
  contents: write

jobs:
  dependabot-auto-merge:
    runs-on: ubuntu-latest
    # Only run for Dependabot PRs
    # Note: auto-merge will wait for CI checks to pass before merging
    if: github.actor == 'dependabot[bot]'

    steps:
      - name: Dependabot metadata
        id: metadata
        uses: dependabot/fetch-metadata@v2
        with:
          github-token: "${{ secrets.GITHUB_TOKEN }}"

      - name: Enable auto-merge for Dependabot PRs
        # Auto-merge patch and minor updates
        if: |
          steps.metadata.outputs.update-type == 'version-update:semver-patch' ||
          steps.metadata.outputs.update-type == 'version-update:semver-minor'
        run: |
          gh pr merge --auto --squash "$PR_URL"
          echo "‚úÖ Auto-merge enabled for PR #${{ github.event.pull_request.number }}"
          echo "Update type: ${{ steps.metadata.outputs.update-type }}"
        env:
          PR_URL: ${{ github.event.pull_request.html_url }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Approve Dependabot PR
        # Approve patch and minor updates automatically
        if: |
          steps.metadata.outputs.update-type == 'version-update:semver-patch' ||
          steps.metadata.outputs.update-type == 'version-update:semver-minor'
        run: |
          gh pr review --approve "$PR_URL"
          echo "‚úÖ PR #${{ github.event.pull_request.number }} approved"
        env:
          PR_URL: ${{ github.event.pull_request.html_url }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Comment on PR
        # Add a comment on successfully enabled auto-merge
        if: |
          steps.metadata.outputs.update-type == 'version-update:semver-patch' ||
          steps.metadata.outputs.update-type == 'version-update:semver-minor'
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: 'ü§ñ **Dependabot Auto-merge enabled**\n\n' +
                    '‚úÖ This PR has been automatically approved and ' +
                    'will be merged once CI checks pass.\n\n' +
                    `**Update type:** \`${{ steps.metadata.outputs.update-type }}\`\n` +
                    `**Dependency name:** ` +
                    `\`${{ steps.metadata.outputs.dependency-names }}\``
            })

      - name: Log skipped major updates
        # Log when major updates are skipped (manual review required)
        if: |
          steps.metadata.outputs.update-type == 'version-update:semver-major'
        run: |
          echo "‚ö†Ô∏è Major update detected - skipping auto-merge"
          echo "PR #${{ github.event.pull_request.number }} requires manual review"
          echo "Update type: ${{ steps.metadata.outputs.update-type }}"
